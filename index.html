<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="robots" content="index, follow">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700&amp;subset=cyrillic" rel="stylesheet" />
    <title>Уведомления</title>

    <style>

    </style>
</head>

<body>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/3.6.8/firebase.js"></script>
    <!-- <script type="text/javascript" src="firebase-messaging-sw.js"></script> -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <!-- <script type="text/javascript" src="firebase_subscribe.js"></script> -->

    <button type="button" class="subscribe" id="sc">Следить за изменениями</button>

    <script>
        // firebase_subscribe.js
        firebase.initializeApp({
            messagingSenderId: '1001598796672'
        });

        // браузер поддерживает уведомления
        // вообще, эту проверку должна делать библиотека Firebase, но она этого не делает
        if ('Notification' in window) {
            var messaging = firebase.messaging();
            console.log("пользователь уже разрешил получение уведомлений");
            // пользователь уже разрешил получение уведомлений
            // подписываем на уведомления если ещё не подписали
            if (Notification.permission === 'granted') {
                console.log("подписываем на уведомления если ещё не подписали");
                subscribe();
            }

            // по клику, запрашиваем у пользователя разрешение на уведомления
            // и подписываем его
            // $('#subscribe').on('click', function () {
            //     subscribe();
            // });

            // $(".subscribe#sc").click(subscribe);

            $(".subscribe#sc").on('click', function () { // по клику, запрашиваем у пользователя разрешение на уведомления и подписываем его
                subscribe();
            });
        }

        function subscribe() {
            // запрашиваем разрешение на получение уведомлений
            messaging.requestPermission()
                .then(function () {
                    // получаем ID устройства
                    messaging.getToken()
                        .then(function (currentToken) {
                            console.log("Текущий токен: " + currentToken);
                            // alert(currentToken);

                            if (currentToken) {
                                console.log("Отправляем токен на сервер...")
                                sendTokenToServer(currentToken);
                            } else {
                                alert('Не удалось получить токен.');
                                console.warn('Не удалось получить токен.');
                                setTokenSentToServer(false);
                            }
                        })
                        .catch(function (err) {
                            alert('При получении токена произошла ошибка: ' + err);
                            console.warn('При получении токена произошла ошибка.', err);
                            setTokenSentToServer(false);
                        });
                })
                .catch(function (err) {
                    alert('Не удалось получить разрешение на показ уведомлений: ' + err);
                    console.warn('Не удалось получить разрешение на показ уведомлений.', err);
                });
        }



        // отправка ID на сервер
        function sendTokenToServer(currentToken) {
            if (!isTokenSentToServer(currentToken)) {
                console.log('Отправка токена на сервер...');

                var url = ''; // адрес скрипта на сервере который сохраняет ID устройства
                $.post(url, {
                    token: currentToken
                });

                setTokenSentToServer(currentToken);
            } else {
                console.log('Токен уже отправлен на сервер.');
            }
        }

        // используем localStorage для отметки того,
        // что пользователь уже подписался на уведомления
        function isTokenSentToServer(currentToken) {
            return window.localStorage.getItem('sentFirebaseMessagingToken') == currentToken;
        }

        function setTokenSentToServer(currentToken) {
            window.localStorage.setItem(
                'sentFirebaseMessagingToken',
                currentToken ? currentToken : ''
            );
        }
    </script>
</body>

</html>